// Define label for Jenkins nodes
def label = "jenkins-builder-${UUID.randomUUID().toString()}"


//if (env.BRANCH_NAME == 'master') {
echo ' ### Iniciando o Jenkins Build - ' + env.APP_NAME  + '###'
  podTemplate(
       label: label,
        containers: [
		        containerTemplate(
		            name: 'jenkins-slave-k8s',
		            image: 'quirinobytes/jenkins-slave-k8s',
		            ttyEnabled: true,
		            command: 'cat'
		         )
        ],
        // Here we set a mount on the pod templete so docker container will have access to the host docker sock.
        volumes: [
            hostPathVolume(mountPath: '/var/run/docker.sock', hostPath: '/var/run/docker.sock'),
        ]
  )
{
    node(label) {
        stage('tem container pra matar?'){
                        try {
                           
                                    def isContainerRunning = sh 'docker ps -aq --filter name=site-superati'
                                    def data = isContainerRunning.split('\n') 

                                    echo '### => Container rodando = '+  isContainerRunning
                                    for (item in data){
                                            sh "docker stop ${item}"
                                            // sh 'docker rm $(docker ps -aq --filter name=site-superati)'
                                            sh "docker rm ${item}"
                                        }
                                        
                                    }
                            }
                             catch (e) {
                                throw e;
                            }
        }
                try {
                    stage('Git Clone - superati') {
                        // checkout scm
                        echo "Git checkout - Site Superati " + env.BRANCH_NAME
                        git url: 'https://github.com/quirinobytes/superati.git'
                    }
                } catch (e) {
                    echo "Erro: Houve falha no git checkout!"
                    // Mark build as failed
                    currentBuild.result == "FAILURE";
                    throw e;
        }

        stage('Install dependencies - npm install') {
                container('jenkins-slave-k8s'){
                    sh 'cd /home/jenkins/workspace/site-superati/www/site ; /usr/bin/npm install'
                }
        }
        stage('Starting app.js - node app') {
                container('jenkins-slave-k8s'){
                    sh 'cd /home/jenkins/workspace/site-superati/www/site ; /usr/bin/node app.js &'
                }
        }
        stage('Kubectl - get pods') {
                container('jenkins-slave-k8s'){
                    sh "kubectl get pods"
                }
        }

        stage('Docker Build - docker build site-superati') {
                container('jenkins-slave-k8s'){
                    sh 'cd /home/jenkins/workspace/site-superati/www/site ; docker build -t quirinobytes/site-superati .'
                    
                    stage('tem container pra matar?'){
                        try {
                           
                                    def isContainerRunning = sh 'docker ps -aq --filter name=site-superati'
                                    def data = isContainerRunning.split('\n') 

                                    echo '### => Container rodando = '+  isContainerRunning
                                    if ( data.size() > 0 ) {
                                        data.each(){
                                            sh "docker stop ${it}"
                                            // sh 'docker rm $(docker ps -aq --filter name=site-superati)'
                                            sh "docker rm ${it}"
                                        }
                                        
                                    }
                            }
                             catch (e) {
                                throw e;
                            }
                    }
                    sh 'docker run --name site-superati -p 1010:1010 -v /var/run/docker.sock:/var/run/docker.sock -d quirinobytes/site-superati  '
                    echo '### SUCESSO ### http://www.superati.com.br:1010/'
                    echo 'Job(https://jenkins.superati.com.br/job/site-superati)'
                }
        }
    }
}
